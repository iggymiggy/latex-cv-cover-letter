% Common package for CV and Cover Letter templates
% Author : iggymiggy
% License : MIT
%
% This package contains all shared packages, settings, and custom commands
% used by both CV and cover letter templates.

%-------------------------
% Package Version Declaration (LaTeX Standard)
%-------------------------
% Standard LaTeX way to declare package version
% Format: \ProvidesPackage{package}[date vversion description]
% This allows LaTeX to identify the package version automatically
\ProvidesPackage{common}[2025/12/16 v1.1.0 CV and Cover Letter Template Common Package]

%-------------------------
% Template Version (User-friendly access)
%-------------------------
% User-friendly commands to access version information
% These extract from \ProvidesPackage declaration above
\newcommand{\templateversion}{1.1.0}
\newcommand{\templateversiondate}{2025-12-16}

%-------------------------
% Note: \loadfile helper macro is defined in each template/company file
% before loading this package, so it's available for use here.
%-------------------------
% Helper Macro for Empty Section Checking
%-------------------------
% \ifnotempty{command}{content if not empty}{content if empty}
%   Checks if a command expands to empty, and conditionally executes content.
%   @param #1: Command to check (e.g., \cvopensource)
%   @param #2: Content to display if command is not empty
%   @param #3: Content to display if command is empty
%   @example: \ifnotempty{\cvopensource}{\section{Open Source}\cvopensource}{}
%   @usage: Use to conditionally show/hide sections based on content
\newcommand{\ifnotempty}[3]{%
  \expandafter\def\expandafter\tempcheck\expandafter{#1}%
  \def\tempempty{}%
  \ifx\tempcheck\tempempty #3\else #2\fi%
}

%-------------------------
% Helper Macro for Conditional Section Visibility
%-------------------------
% \conditionalsection{command}{section content}
%   Shows a section only if the command is not empty.
%   Convenience wrapper around \ifnotempty that hides section when empty.
%   @param #1: Command to check (e.g., \cvopensource, \cvvolunteer)
%   @param #2: Section content to display if command is not empty
%   @example: \conditionalsection{\cvopensource}{\section{Open Source}\cvopensource}
%   @usage: Use to conditionally show optional CV sections
%   @note: If command is empty, nothing is displayed (no empty section)
\newcommand{\conditionalsection}[2]{%
  \ifnotempty{#1}{#2}{}%
}

%-------------------------
% Packages (shared by CV and Cover Letter)
%-------------------------
\RequirePackage{latexsym}
\RequirePackage[empty]{fullpage}
\RequirePackage{titlesec}
\RequirePackage{marvosym}
\RequirePackage[usenames,dvipsnames]{color}
\RequirePackage{xcolor}
\RequirePackage{verbatim}
\RequirePackage{enumitem}
\RequirePackage[hidelinks]{hyperref}
\RequirePackage{fancyhdr}
\RequirePackage{tabularx}
\RequirePackage{fontawesome5}  % Font awesome icons (LinkedIn and GitHub icons)

% Note: babel, inputenc, etoolbox, and glyphtounicode are loaded in templates
% as they may differ between CV and cover letter (e.g., cover letter uses finnish,english)
%
% Standardized glyphtounicode usage:
% - CV files: MUST use \input{glyphtounicode} (needed for ATS parsing of CVs)
% - Cover letter files: DO NOT use glyphtounicode - \pdfgentounicode=1 (set below) already handles Unicode

%-------------------------
% Page Setup
%-------------------------
\pagestyle{fancy}
\fancyhf{} % Clear all header and footer fields
\fancyfoot{}
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}

% Adjust margins
\addtolength{\oddsidemargin}{-0.5in}
\addtolength{\evensidemargin}{-0.5in}
\addtolength{\textwidth}{1in}
\addtolength{\topmargin}{-.5in}
\addtolength{\textheight}{1.0in}

\urlstyle{same}

\raggedbottom
\raggedright
\setlength{\tabcolsep}{0in}

%-------------------------
% Section Formatting
%-------------------------
\titleformat{\section}{
  \vspace{-4pt}\scshape\raggedright\large
}{}{0em}{}[\color{black}\titlerule \vspace{-5pt}]

% Ensure that generate PDF is machine readable/ATS parsable
\pdfgentounicode=1

%-------------------------
% PDF Metadata Setup
%-------------------------
% Set PDF metadata including template version
% Uses standard PDF metadata fields for better compatibility
% Standard fields are visible in all PDF readers
% 
% Customizable fields (can be set in company files):
% - \pdfmetatitle: PDF title (default: auto-generated from name and CV title)
% - \pdfmetaauthor: PDF author (default: \myname)
% - \pdfmetasubject: PDF subject (default: template version)
% - \pdfmetakeywords: PDF keywords (default: CV, Resume, LaTeX, version)
\newcommand{\setpdfmetadata}{%
  % Helper: Check if command expands to empty and set default if needed
  % This avoids modifying user-defined commands, instead using temporary variables
  \def\tempempty{}%
  
  % Check and prepare title
  \expandafter\def\expandafter\tempchecktitle\expandafter{\pdfmetatitle}%
  \ifx\tempchecktitle\tempempty
    % Auto-generate: Expand \myname and \cvtitle to get actual values
    \edef\temppdftitle{\myname{} - \cvtitle}%
  \else
    % Use user-defined value, but expand it
    \edef\temppdftitle{\pdfmetatitle}%
  \fi
  
  % Check and prepare author
  \expandafter\def\expandafter\tempcheckauthor\expandafter{\pdfmetaauthor}%
  \ifx\tempcheckauthor\tempempty
    \edef\temppdfauthor{\myname}%
  \else
    \edef\temppdfauthor{\pdfmetaauthor}%
  \fi
  
  % Check and prepare subject
  \expandafter\def\expandafter\tempchecksubject\expandafter{\pdfmetasubject}%
  \ifx\tempchecksubject\tempempty
    \edef\temppdfsubject{CV Template v\templateversion (\templateversiondate)}%
  \else
    \edef\temppdfsubject{\pdfmetasubject}%
  \fi
  
  % Check and prepare keywords
  \expandafter\def\expandafter\tempcheckkeywords\expandafter{\pdfmetakeywords}%
  \ifx\tempcheckkeywords\tempempty
    \edef\temppdfkeywords{CV, Resume, LaTeX, Template v\templateversion}%
  \else
    \edef\temppdfkeywords{\pdfmetakeywords}%
  \fi
  
  % Set PDF metadata via hyperref (using expanded values)
  \hypersetup{%
    pdftitle={\temppdftitle},
    pdfauthor={\temppdfauthor},
    pdfsubject={\temppdfsubject},
    pdfkeywords={\temppdfkeywords},
    pdfcreator={LaTeX CV Template System v\templateversion},
    pdfproducer={pdflatex},
  }%
  % Also set custom metadata for advanced tools (may not be visible in all readers)
  \pdfinfo{%
    /TemplateVersion (\templateversion)%
    /TemplateVersionDate (\templateversiondate)%
  }%
}

%-------------------------
% Custom CV/Resume Commands
%-------------------------

% \cvItem{label}{content}
%   Creates a list item with a bold label followed by content.
%   @param #1: Label text (displayed in bold)
%   @param #2: Content text (displayed after colon)
%   @example: \cvItem{Programming Languages}{Python, Java, C++}
%   @usage: Use inside \cvItemListStart ... \cvItemListEnd
\newcommand{\cvItem}[2]{%
  \item\small{%
    \textbf{#1}{: #2 \vspace{-2pt}}%
  }%
}

% \cvItemSimple{label}{content}
%   Creates a simple list item without a label (just content).
%   @param #1: Unused (kept for consistency with \cvItem)
%   @param #2: Content text
%   @example: \cvItemSimple{}{Implemented REST API with Flask}
%   @usage: Use inside \cvItemListStart ... \cvItemListEnd
\newcommand{\cvItemSimple}[2]{%
  \item\small{%
    #2 \vspace{-2pt}%
  }%
}

% \cvHeading{name}{right-align}{title}{right-align}
%   Creates a heading that does not need to be in a list.
%   Typically used for the main header section.
%   @param #1: Name or main text (left-aligned, bold)
%   @param #2: Right-aligned text (e.g., location, date)
%   @param #3: Title or subtitle (left-aligned, italic, small)
%   @param #4: Right-aligned subtitle (italic, small)
%   @example: \cvHeading{John Doe}{San Francisco, CA}{Software Engineer}{2020-Present}
%   @usage: Can be used standalone (not in a list)
\newcommand{\cvHeading}[4]{%
    \begin{tabular*}{0.99\textwidth}[t]{l@{\extracolsep{\fill}}r}%
      \textbf{#1} & #2 \\%
      \textit{\small#3} & \textit{\small #4} \\%
    \end{tabular*}\vspace{-5pt}%
}

% \cvSubheading{title}{date}{company}{location}
%   Creates a subheading used within lists (e.g., Experience, Education).
%   @param #1: Job title or degree name (bold)
%   @param #2: Date range (right-aligned)
%   @param #3: Company or institution name (italic, small, left-aligned)
%   @param #4: Location (italic, small, right-aligned)
%   @example: \cvSubheading{Senior Software Engineer}{2020-2023}{Google}{Mountain View, CA}
%   @usage: Use inside \cvSubHeadingListStart ... \cvSubHeadingListEnd
\newcommand{\cvSubheading}[4]{%
  \vspace{-1pt}\item%
    \begin{tabular*}{0.97\textwidth}[t]{l@{\extracolsep{\fill}}r}%
      \textbf{#1} & #2 \\%
      \textit{\small#3} & \textit{\small #4} \\%
    \end{tabular*}\vspace{-5pt}%
}

% \cvSubSubheading{position}{date}
%   Creates a sub-subheading for multiple positions at the same company.
%   Used when you have multiple roles at one company.
%   @param #1: Position title (italic, small, left-aligned)
%   @param #2: Date range (italic, small, right-aligned)
%   @example: \cvSubSubheading{Junior Software Engineer}{2018-2020}
%   @usage: Use after \cvSubheading for the same company
\newcommand{\cvSubSubheading}[2]{%
    \begin{tabular*}{0.97\textwidth}{l@{\extracolsep{\fill}}r}%
      \textit{\small#1} & \textit{\small #2} \\%
    \end{tabular*}\vspace{-5pt}%
}

% \cvSubheadingWithDetails{title}{date}{institution}{location}{major}{minor}
%   Creates a subheading with education details (major and minor).
%   Similar to \cvSubheading but includes major/minor fields.
%   @param #1: Degree name (bold)
%   @param #2: Date (right-aligned)
%   @param #3: Institution name (italic, small, left-aligned)
%   @param #4: Location (italic, small, right-aligned)
%   @param #5: Major field of study
%   @param #6: Minor field of study (can be empty)
%   @example: \cvSubheadingWithDetails{Bachelor of Science}{2014-2018}{MIT}{Cambridge, MA}{Computer Science}{Mathematics}
%   @usage: Use inside \cvSubHeadingListStart ... \cvSubHeadingListEnd for Education section
\newcommand{\cvSubheadingWithDetails}[6]{%
  \vspace{-1pt}\item%
    \begin{tabular*}{0.97\textwidth}[t]{l@{\extracolsep{\fill}}r}%
      \textbf{#1} & #2 \\%
      \textit{\small#3} & \textit{\small#4} \\%
    \end{tabular*}%
    \vspace{-3pt} % Adjust spacing as needed
    \begin{tabular*}{0.97\textwidth}[t]{l}%
      \textit{\small Major: #5 \hspace{20pt} Minor: #6} \\%
    \end{tabular*}%
    \vspace{-5pt} % Adjust spacing after details
}

% \cvSubItem{label}{content}
%   Creates a nested sub-item (used for bullet points under a main item).
%   @param #1: Label text (bold)
%   @param #2: Content text
%   @example: \cvSubItem{Technologies}{Python, Docker, Kubernetes}
%   @usage: Use inside \cvItemListStart ... \cvItemListEnd (nested within a main item)
\newcommand{\cvSubItem}[2]{\cvItem{#1}{#2}\vspace{-4pt}}

% List item marker (circular bullet for nested lists)
\renewcommand{\labelitemii}{$\circ$}

% \cvSubHeadingListStart ... \cvSubHeadingListEnd
%   Wrapper for itemize environment used for main sections (Experience, Education).
%   Uses leftmargin=* to remove left margin.
%   @usage: Wrap \cvSubheading commands
%   @example:
%     \cvSubHeadingListStart
%       \cvSubheading{Engineer}{2020-2023}{Company}{Location}
%     \cvSubHeadingListEnd
\newcommand{\cvSubHeadingListStart}{\begin{itemize}[leftmargin=*]}
\newcommand{\cvSubHeadingListEnd}{\end{itemize}}

% \cvItemListStart ... \cvItemListEnd
%   Wrapper for standard itemize environment used for bullet points.
%   @usage: Wrap \cvItem or \cvItemSimple commands
%   @example:
%     \cvItemListStart
%       \cvItem{Language}{Python}
%       \cvItem{Framework}{Django}
%     \cvItemListEnd
\newcommand{\cvItemListStart}{\begin{itemize}}
\newcommand{\cvItemListEnd}{\end{itemize}\vspace{-5pt}}

% \cvProjectItem{name}{type}{date}{description}
%   Creates a formatted project entry with name, type, date, and description.
%   @param #1: Project name (bold)
%   @param #2: Project type or category (italic)
%   @param #3: Date (right-aligned, italic, small)
%   @param #4: Project description (displayed as nested bullet)
%   @example: \cvProjectItem{Web App}{Personal Project}{2023}{Built with React and Node.js}
%   @usage: Use inside \cvItemListStart ... \cvItemListEnd
\newcommand{\cvProjectItem}[4]{%
  \item\small{%
    \textbf{#1} â€” \textit{#2} \hfill \textit{\small #3}%
  }%
  \vspace{-4pt}%
  \begin{itemize}[leftmargin=1em]%
    \item\small{#4 \vspace{-2pt}}%
  \end{itemize}%
}

%-------------------------
% Certificates Section
%-------------------------
% \cvCertificates{content}
%   Creates a formatted certificates section with two-column layout.
%   @param #1: Certificate entries (each entry should end with \\)
%   @example:
%     \cvCertificates{%
%       \textbf{AWS Certified} & \textcolor{gray}{\textit{2023}} \\
%       \textbf{Kubernetes Admin} & \textcolor{gray}{\textit{2022}} \\
%     }
%   @note: Use \href{url}{\textbf{Name}} for clickable certificate links
%   @usage: Call directly in CV body (not inside a list)
\newcommand{\cvCertificates}[1]{%
  \vspace{-4pt}%
  \section*{Certificates}%
  \vspace{-3pt}%
  \begin{tabularx}{\textwidth}{X r} % Two-column layout
    #1
  \end{tabularx}%
  \vspace{-5pt} % Reduce bottom space
}

%-------------------------
% Cover Letter Section Command
%-------------------------
% \lettersection{title}
%   Creates a section heading for cover letter with a horizontal rule.
%   Used to separate different parts of the cover letter body.
%   @param #1: Section title (displayed in large, bold)
%   @example: \lettersection{Why I'm a Great Fit}
%   @usage: Use in cover letter body to create section breaks
%   @note: Can be overridden in company cover_letter.tex for custom styling
\newcommand{\lettersection}[1]{%
  \vspace{12pt}%
  \noindent{\large\bfseries #1} \textcolor{gray}{\hrulefill} \\%
  \vspace{6pt}%
}

%-------------------------
% Cover Letter Date Setup Helper
%-------------------------
% Sets up date language and handles auto-date conversion
% Uses \letterdatelanguage and \letterdate commands (should be defined in cover_letter.tex)
% This centralizes the date handling logic while keeping values company-specific
%
% Note: babel package must be loaded with the desired languages (e.g., [finnish,english])
% The language name in \letterdatelanguage must match a language loaded in babel
\newcommand{\setupcoverletterdate}{%
  % Set date language (from \letterdatelanguage, company-specific)
  % Uses babel's \selectlanguage directly - works with any language loaded in babel
  \selectlanguage{\letterdatelanguage}%
  % Set date (auto uses \today, respects language setting)
  \def\checkdateauto{auto}%
  \edef\letterdateexpanded{\letterdate}%
  \ifx\letterdateexpanded\checkdateauto
    \renewcommand{\letterdate}{\today}%
  \fi
}

%-------------------------
% Configuration Validation Helper
%-------------------------
% \checkfield{command}{fieldname}{placeholdertext}
%   Checks if a field is empty or contains placeholder/example values.
%   @param #1: Command to check (e.g., \myname)
%   @param #2: Field name for error message (e.g., "Name")
%   @param #3: Placeholder text to check against (empty string if no placeholder check)
%   @usage: Internal helper for \validateconfig
\newcommand{\checkfield}[3]{%
  \expandafter\def\expandafter\tempcheck\expandafter{#1}%
  \def\tempempty{}%
  \ifx\tempcheck\tempempty
    \PackageWarning{config}{Missing required field: #2. Please set #1 in personal_info.tex or company configuration.}%
  \else
    % Check for placeholder values if provided
    \def\tempemptyplaceholder{}%
    \def\tempcheckplaceholder{#3}%
    \ifx\tempcheckplaceholder\tempemptyplaceholder
      % No placeholder check needed
    \else
      \ifx\tempcheck\tempcheckplaceholder
        \PackageWarning{config}{Field #2 appears to contain placeholder value "#3". Please update #1 with your real information.}%
      \fi
    \fi
  \fi
}

% \validateconfigcv
%   Validates required fields for CV compilation.
%   Checks personal information and CV title.
%   @usage: Call after loading personal_info.tex and base_config.tex
%   @note: Uses LaTeX warnings, so compilation continues but user is notified
\newcommand{\validateconfigcv}{%
  \PackageInfo{config}{Validating CV configuration...}%
  % Check required personal information fields
  \checkfield{\myname}{Name}{John Doe}%
  \checkfield{\myemail}{Email}{example@example.com}%
  \checkfield{\myphone}{Phone}{+1 (555) 000-0000}%
  % Optional fields: LinkedIn, GitHub, Portfolio (only warn if placeholder values detected)
  \expandafter\def\expandafter\tempcheck\expandafter{\mylinkedin}%
  \def\tempempty{}%
  \ifx\tempcheck\tempempty
    % Empty is fine (optional field)
  \else
    \def\tempcheckplaceholder{exampleusername}%
    \ifx\tempcheck\tempcheckplaceholder
      \PackageWarning{config}{LinkedIn username appears to contain placeholder value. Please update \mylinkedin with your real information, or leave it empty if not applicable.}%
    \fi
  \fi
  \expandafter\def\expandafter\tempcheck\expandafter{\mygithub}%
  \ifx\tempcheck\tempempty
    % Empty is fine (optional field)
  \else
    \def\tempcheckplaceholder{exampleusername}%
    \ifx\tempcheck\tempcheckplaceholder
      \PackageWarning{config}{GitHub username appears to contain placeholder value. Please update \mygithub with your real information, or leave it empty if not applicable.}%
    \fi
  \fi
  \expandafter\def\expandafter\tempcheck\expandafter{\myportfolio}%
  \ifx\tempcheck\tempempty
    % Empty is fine (optional field)
  \else
    \def\tempcheckplaceholder{example.github.io}%
    \ifx\tempcheck\tempcheckplaceholder
      \PackageWarning{config}{Portfolio appears to contain placeholder value. Please update \myportfolio with your real information, or leave it empty if not applicable.}%
    \fi
  \fi
  % Check CV title (should be customized per company)
  \expandafter\def\expandafter\tempcheck\expandafter{\cvtitle}%
  \def\tempdefault{Cloud Evangelist | AI Whisperer}%
  \ifx\tempcheck\tempdefault
    \PackageWarning{config}{CV title is using default value. Consider customizing \cvtitle in companies/*/shared.tex for better results.}%
  \fi
}

% \validateconfigcoverletter
%   Validates required fields for cover letter compilation.
%   Checks personal information, company details, and letter content.
%   @usage: Call after loading personal_info.tex, base_config.tex, and company cover_letter.tex
%   @note: Uses LaTeX warnings, so compilation continues but user is notified
\newcommand{\validateconfigcoverletter}{%
  \PackageInfo{config}{Validating cover letter configuration...}%
  % Check personal information fields
  \checkfield{\myname}{Name}{John Doe}%
  \checkfield{\myemail}{Email}{example@example.com}%
  \checkfield{\myphone}{Phone}{+1 (555) 000-0000}%
  % Check company details (should be customized)
  \expandafter\def\expandafter\tempcheck\expandafter{\companyname}%
  \def\tempdefault{Company Name}%
  \ifx\tempcheck\tempdefault
    \PackageWarning{config}{Company name is using default value. Please set \companyname in companies/*/cover_letter.tex.}%
  \fi
  \expandafter\def\expandafter\tempcheck\expandafter{\companyrecipient}%
  \def\tempdefault{Hiring Manager}%
  \ifx\tempcheck\tempdefault
    \PackageWarning{config}{Company recipient is using default value. Consider customizing \companyrecipient in companies/*/cover_letter.tex.}%
  \fi
  \expandafter\def\expandafter\tempcheck\expandafter{\companyaddress}%
  \def\tempdefault{Address}%
  \ifx\tempcheck\tempdefault
    \PackageWarning{config}{Company address is using default value. Please set \companyaddress in companies/*/cover_letter.tex.}%
  \fi
  \expandafter\def\expandafter\tempcheck\expandafter{\companycity}%
  \def\tempdefault{City, State ZIP}%
  \ifx\tempcheck\tempdefault
    \PackageWarning{config}{Company city is using default value. Please set \companycity in companies/*/cover_letter.tex.}%
  \fi
  % Check letter body (check for lorem ipsum - simplified check)
  \expandafter\def\expandafter\tempcheck\expandafter{\letterbody}%
  % We check if it starts with "Lorem ipsum" as a simple placeholder detection
  % This is a basic check - full text comparison would be too complex
  \def\tempcheckstart{Lorem ipsum}%
  \expandafter\def\expandafter\tempcheckfirst\expandafter{\expandafter\tempcheck\expandafter}%
  % Note: Full lorem ipsum detection is complex, so we just warn if it's likely placeholder
  % Users will see the warning and can verify their letter body is customized
}

